{"version":3,"file":"Input.js","names":["cachedSecrets","token","secretKey","enableSignedUrls","signingKeyId","signingKeyPrivate","validateSecrets","secrets","getSecrets","Promise","resolve","isInitialSetup","needsSetup","fetchSecrets","then","exists","withDocument","MuxVideoInput","Component","assetDocument","confirmRemove","deleteOnMuxChecked","deleteAssetDocumentChecked","error","hasFocus","isLoading","showSetup","showBrowser","videoReadyToPlay","setState","state","pollInterval","setInterval","getAsset","assetId","response","props","data","client","patch","_id","set","status","commit","returnDocuments","catch","prevState","result","onChange","PatchEvent","from","setIfMissing","asset","_type","_ref","document","setupAssetListener","unsetAsset","reject","unset","undefined","delete","deleteAsset","componentDidMount","value","componentWillUnmount","subscription","unsubscribe","clearInterval","observePaths","pipe","tap","handleRemoveVideo","Error","errors","messages","join","static_renditions","pollMux","config","mp4_support","of","subscribe","render","type","level","markers","position","title","description","styles","formField","handleCancelSaveSetup","handleSaveSetup","handleSetupButtonClicked","handleBlur","handleFocus","handleOnUploadComplete","handleBrowseButton","handleRemoveVideoButtonClicked","readOnly","handleVideoReadyToPlay","handleCloseBrowser","handleSelectAsset","handleCancelRemove","handleDeleteOnMuxCheckBoxClicked","margin","handleDeleteAssetDocumentCheckBoxClicked","handleErrorClose"],"sources":["../../src/components/Input.tsx"],"sourcesContent":["import type {SanityDocument} from '@sanity/types'\nimport {Box, Button, Checkbox, Dialog, Flex, Grid, Inline, Stack, Text} from '@sanity/ui'\nimport {observePaths} from 'part:@sanity/base/preview'\nimport FormField from 'part:@sanity/components/formfields/default'\nimport Spinner from 'part:@sanity/components/loading/spinner'\nimport {withDocument} from 'part:@sanity/form-builder'\nimport PatchEvent, {set, setIfMissing, unset} from 'part:@sanity/form-builder/patch-event'\nimport React, {Component} from 'react'\nimport {of} from 'rxjs'\nimport {tap} from 'rxjs/operators'\n\nimport {deleteAsset, getAsset} from '../actions/assets'\nimport {fetchSecrets} from '../actions/secrets'\nimport client from '../clients/SanityClient'\nimport config from '../config'\nimport type {Secrets, VideoAssetDocument} from '../util/types'\nimport styles from './Input.css'\nimport InputBrowser from './InputBrowser'\nimport InputError from './InputError'\nimport SetupButton from './SetupButton'\nimport SetupNotice from './SetupNotice'\nimport Uploader from './Uploader'\n\nconst cachedSecrets: Secrets = {\n  token: null,\n  secretKey: null,\n  enableSignedUrls: false,\n  signingKeyId: null,\n  signingKeyPrivate: null,\n}\n\nfunction validateSecrets(secrets: Secrets) {\n  if (!secrets.token || !secrets.secretKey) return false\n\n  return true\n}\n\nfunction getSecrets(): Promise<{isInitialSetup: boolean; needsSetup: boolean; secrets: Secrets}> {\n  if (cachedSecrets.token) {\n    return Promise.resolve({\n      isInitialSetup: true,\n      needsSetup: false,\n      secrets: cachedSecrets,\n    })\n  }\n  return fetchSecrets().then(({secrets, exists}) => {\n    cachedSecrets.token = secrets?.token ?? null\n    cachedSecrets.secretKey = secrets?.secretKey ?? null\n    cachedSecrets.enableSignedUrls = secrets?.enableSignedUrls ?? false\n    cachedSecrets.signingKeyId = secrets?.signingKeyId ?? null\n    cachedSecrets.signingKeyPrivate = secrets?.signingKeyPrivate ?? null\n\n    return {\n      isInitialSetup: !exists,\n      needsSetup: !validateSecrets(cachedSecrets),\n      secrets: cachedSecrets,\n    }\n  })\n}\n\ninterface Props {\n  document: SanityDocument\n  value?: null | {asset?: {_type: 'reference'; _ref: string}}\n  type: any\n  level: any\n  markers: any\n  onChange: any\n  readOnly: boolean\n}\n\ninterface State {\n  assetDocument: VideoAssetDocument | null\n  confirmRemove: boolean\n  deleteOnMuxChecked: boolean\n  deleteAssetDocumentChecked: boolean\n  error: Error | null\n  hasFocus: boolean\n  isInitialSetup: boolean\n  isLoading: boolean | 'secrets'\n  needsSetup: boolean\n  secrets: Secrets | null\n  showSetup: boolean\n  showBrowser: boolean\n  videoReadyToPlay: boolean\n}\n\nexport default withDocument(\n  class MuxVideoInput extends Component<Props, State> {\n    state: State = {\n      assetDocument: null,\n      confirmRemove: false,\n      deleteOnMuxChecked: false,\n      deleteAssetDocumentChecked: true,\n      error: null,\n      hasFocus: false,\n      isInitialSetup: true,\n      isLoading: 'secrets',\n      needsSetup: true,\n      secrets: null,\n      showSetup: false,\n      showBrowser: false,\n      videoReadyToPlay: false,\n    }\n\n    pollInterval?: number\n    // eslint-disable-next-line no-warning-comments\n    // @TODO setup proper Observable typings\n    subscription?: any\n\n    componentDidMount() {\n      getSecrets()\n        .then(({secrets, isInitialSetup, needsSetup}) => {\n          this.setState({\n            secrets,\n            isInitialSetup,\n            needsSetup,\n            // If there is an asset continue loading\n            isLoading: !!this.props.value?.asset,\n          })\n        })\n        .catch((error) => this.setState({error}))\n      this.setupAssetListener()\n    }\n\n    componentWillUnmount() {\n      if (this.subscription) {\n        this.subscription.unsubscribe()\n      }\n      if (this.pollInterval) {\n        clearInterval(this.pollInterval)\n        this.pollInterval = undefined\n      }\n    }\n\n    handleFocus = () => {\n      this.setState({hasFocus: true})\n    }\n\n    handleBlur = () => {\n      this.setState({hasFocus: false})\n    }\n\n    getAsset() {\n      const {value} = this.props\n      return value ? value.asset : null\n    }\n\n    setupAssetListener() {\n      if (this.subscription) {\n        this.subscription.unsubscribe()\n      }\n      this.setState({videoReadyToPlay: false})\n      const asset = this.getAsset()\n      if (!asset) {\n        return\n      }\n      this.subscription = observePaths(asset, [\n        'thumbTime',\n        'data',\n        'assetId',\n        'playbackId',\n        'status',\n      ])\n        .pipe(\n          tap((assetDocument: VideoAssetDocument) => {\n            this.setState({assetDocument})\n            if (assetDocument && assetDocument.status === 'errored') {\n              clearInterval(this.pollInterval)\n              this.pollInterval = undefined\n              // eslint-disable-next-line no-warning-comments\n              // todo: use client.observable\n              return this.handleRemoveVideo().then(() => {\n                this.setState({\n                  isLoading: false,\n                  error: new Error(assetDocument.data?.errors?.messages?.join(' ')),\n                })\n              })\n            }\n            // Poll MUX if it's preparing the main document or its own static renditions\n            if (\n              assetDocument?.status === 'preparing' ||\n              assetDocument?.data?.static_renditions?.status === 'preparing'\n            ) {\n              this.pollMux()\n            }\n            // If MP4 support is enabled: MUX will prepare static_renditions only _after_ an asset\n            // has been successfully uploaded.\n            // A _ready_ asset doesn't mean static mp4s are generated and ready for use!\n            // In these cases, wait for `static_renditions.status === 'ready'` before clearing the poll interval.\n            if (assetDocument && assetDocument.status === 'ready') {\n              switch (config.mp4_support) {\n                case 'standard':\n                  if (assetDocument?.data?.static_renditions?.status === 'ready') {\n                    clearInterval(this.pollInterval)\n                    this.pollInterval = undefined\n                  }\n                  break\n                case 'none':\n                default:\n                  clearInterval(this.pollInterval)\n                  this.pollInterval = undefined\n                  break\n              }\n            }\n\n            this.setState({\n              assetDocument,\n              isLoading: false,\n            })\n\n            return of(assetDocument)\n          })\n        )\n        .subscribe()\n    }\n\n    pollMux = () => {\n      const assetDocument = this.state.assetDocument\n      if (!assetDocument) {\n        return\n      }\n      if (this.pollInterval) {\n        return\n      }\n      this.pollInterval = (setInterval as typeof window.setInterval)(() => {\n        getAsset(assetDocument.assetId!)\n          .then((response) => {\n            const props = response.data\n\n            client\n              .patch(assetDocument._id!)\n              .set({\n                status: props.status,\n                data: props,\n              })\n              .commit({returnDocuments: false})\n          })\n          .catch((error) => {\n            this.setState({error})\n          })\n      }, 2000)\n    }\n\n    handleSetupButtonClicked = () => {\n      this.setState((prevState) => ({showSetup: !prevState.showSetup}))\n    }\n\n    handleSaveSetup = ({\n      token,\n      secretKey,\n      enableSignedUrls,\n      signingKeyId,\n      signingKeyPrivate,\n    }: Secrets) => {\n      cachedSecrets.token = token\n      cachedSecrets.secretKey = secretKey\n      cachedSecrets.enableSignedUrls = enableSignedUrls\n      cachedSecrets.signingKeyId = signingKeyId\n      cachedSecrets.signingKeyPrivate = signingKeyPrivate\n\n      this.setState({\n        showSetup: false,\n        secrets: cachedSecrets,\n        needsSetup: !validateSecrets(cachedSecrets),\n      })\n    }\n\n    handleCancelSaveSetup = () => {\n      this.setState({showSetup: false})\n    }\n\n    handleOnUploadComplete = (result: any) => {\n      const {onChange} = this.props\n      const {_id} = result\n      onChange(\n        PatchEvent.from([\n          setIfMissing({asset: {}}),\n          set({_type: 'reference', _ref: _id}, ['asset']),\n        ])\n      )\n      this.setState({assetDocument: result.document}, () => {\n        this.setupAssetListener()\n      })\n    }\n\n    handleRemoveVideoButtonClicked = () => {\n      this.setState({confirmRemove: true})\n    }\n\n    handleRemoveVideo = () => {\n      const {assetDocument} = this.state\n      this.setState({isLoading: true})\n      const unsetAsset = () => {\n        return new Promise<any>((resolve, reject) => {\n          this.setState(\n            {\n              assetDocument: null,\n              confirmRemove: false,\n              isLoading: false,\n            },\n            () => {\n              if (this.state.deleteOnMuxChecked || this.state.deleteAssetDocumentChecked) {\n                return client\n                  .patch(this.props.document._id)\n                  .unset(['video'])\n                  .commit({returnDocuments: false})\n                  .then(() => {\n                    if (!assetDocument) {\n                      return resolve(undefined)\n                    }\n                    return client\n                      .delete(assetDocument._id!)\n                      .then(() => {\n                        resolve(undefined)\n                      })\n                      .catch((error) => {\n                        reject(error)\n                      })\n                  })\n              }\n              return this.props.onChange(PatchEvent.from(unset()))\n            }\n          )\n        })\n      }\n      return unsetAsset()\n        .then(() => {\n          if (this.state.deleteOnMuxChecked) {\n            return deleteAsset(assetDocument!.assetId!).catch((error) => {\n              this.setState({error})\n            })\n          }\n          return true as any\n        })\n        .catch((error) => {\n          this.setState({error})\n        })\n    }\n\n    handleCancelRemove = () => {\n      this.setState({\n        confirmRemove: false,\n        deleteOnMuxChecked: true,\n        deleteAssetDocumentChecked: true,\n      })\n    }\n\n    handleDeleteOnMuxCheckBoxClicked = () => {\n      this.setState((prevState) => ({\n        deleteOnMuxChecked: !prevState.deleteOnMuxChecked,\n      }))\n    }\n\n    handleDeleteAssetDocumentCheckBoxClicked = () => {\n      this.setState((prevState) => ({\n        deleteAssetDocumentChecked: !prevState.deleteAssetDocumentChecked,\n      }))\n    }\n\n    handleErrorClose = () => {\n      this.setState({\n        error: null,\n      })\n    }\n\n    handleBrowseButton = () => {\n      this.setState({showBrowser: true})\n    }\n\n    handleCloseBrowser = () => {\n      this.setState({showBrowser: false})\n    }\n\n    handleSelectAsset = (asset: VideoAssetDocument) => {\n      const {onChange} = this.props\n\n      onChange(\n        PatchEvent.from([\n          setIfMissing({asset: {}}),\n          set({_type: 'reference', _ref: asset._id}, ['asset']),\n        ])\n      )\n\n      this.setState({showBrowser: false, assetDocument: asset}, () => {\n        this.setupAssetListener()\n      })\n    }\n\n    handleVideoReadyToPlay = () => {\n      this.setState({videoReadyToPlay: true})\n    }\n\n    render() {\n      const {type, level, markers} = this.props\n\n      return (\n        <>\n          <Box style={{position: 'relative'}}>\n            <Flex align=\"center\" justify=\"space-between\">\n              <FormField\n                label={type.title}\n                markers={markers}\n                description={type.description}\n                level={level}\n                className={styles.formField}\n              />\n              <SetupButton\n                isLoading={this.state.isLoading}\n                needsSetup={this.state.needsSetup}\n                onCancel={this.handleCancelSaveSetup}\n                onSave={this.handleSaveSetup}\n                onSetup={this.handleSetupButtonClicked}\n                secrets={this.state.secrets}\n                showSetup={this.state.showSetup}\n              />\n            </Flex>\n            {this.state.isLoading === 'secrets' && (\n              <Box marginBottom={2}>\n                <Inline space={2}>\n                  <Spinner inline />\n                  <Text size={1}>Fetching credentials</Text>\n                </Inline>\n              </Box>\n            )}\n\n            {this.state.needsSetup && (\n              <SetupNotice\n                isLoading={this.state.isLoading}\n                isInitialSetup={this.state.isInitialSetup}\n              />\n            )}\n\n            {!this.state.needsSetup && this.state.secrets && (\n              <Uploader\n                hasFocus={this.state.hasFocus}\n                onBlur={this.handleBlur}\n                onFocus={this.handleFocus}\n                onSetupButtonClicked={this.handleSetupButtonClicked}\n                onUploadComplete={this.handleOnUploadComplete}\n                secrets={this.state.secrets}\n                onBrowse={this.handleBrowseButton}\n                asset={this.state.assetDocument!}\n                onRemove={this.handleRemoveVideoButtonClicked}\n                readOnly={this.props.readOnly}\n                handleVideoReadyToPlay={this.handleVideoReadyToPlay}\n                videoReadyToPlay={this.state.videoReadyToPlay}\n                handleRemoveVideo={this.handleRemoveVideo}\n              />\n            )}\n\n            {this.state.showBrowser && (\n              <InputBrowser\n                onClose={this.handleCloseBrowser}\n                onSelect={this.handleSelectAsset}\n                secrets={this.state.secrets!}\n              />\n            )}\n\n            {this.state.confirmRemove && (\n              <Dialog id=\"remove-video\" header=\"Remove video\" zOffset={1000} onClose={this.handleCancelRemove}>\n                <Box padding={4}>\n                  <Stack space={3}>\n                    <Flex align=\"center\">\n                      <Checkbox\n                        checked={this.state.deleteOnMuxChecked}\n                        onChange={this.handleDeleteOnMuxCheckBoxClicked}\n                      />\n                      <Text style={{margin: '0 10px'}}>Delete asset on Mux</Text>\n                    </Flex>\n                    <Flex align=\"center\">\n                      <Checkbox\n                        disabled={this.state.deleteOnMuxChecked}\n                        checked={\n                          this.state.deleteOnMuxChecked || this.state.deleteAssetDocumentChecked\n                        }\n                        onChange={this.handleDeleteAssetDocumentCheckBoxClicked}\n                      />\n                      <Text style={{margin: '0 10px'}}>Delete video from dataset</Text>\n                    </Flex>\n                    <Grid columns={2} gap={2}>\n                      <Button\n                        mode=\"ghost\"\n                        tone=\"default\"\n                        text=\"Cancel\"\n                        onClick={this.handleCancelRemove}\n                        loading={!!this.state.isLoading}\n                      />\n                      <Button\n                        mode=\"default\"\n                        tone=\"critical\"\n                        text=\"Remove\"\n                        onClick={this.handleRemoveVideo}\n                        loading={!!this.state.isLoading}\n                      />\n                    </Grid>\n                  </Stack>\n                </Box>\n              </Dialog>\n            )}\n\n            {this.state.error && (\n              <InputError error={this.state.error} onClose={this.handleErrorClose} />\n            )}\n          </Box>\n        </>\n      )\n    }\n  }\n)\n"],"mappings":"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"}